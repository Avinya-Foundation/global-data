name: Release workflow

on:
  release:
    types:
      - "published"

jobs:
  update-version:
    runs-on: ubuntu-22.04
    name: Update package version numbers
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      # See: https://stackoverflow.com/questions/58177786/get-the-current-pushed-tag-in-github-actions
      - name: Set env
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/v}" >> $GITHUB_ENV
      - name: Test
        run: |
          echo $RELEASE_VERSION
          echo ${{ env.RELEASE_VERSION }}
      - name: Install tom-cli to modify toml file
        run: |
          python -m pip install toml-cli
      - name: Update version in Ballerina.toml files
        run: |
          OLD_VERSION=$(toml get --toml-path api/Ballerina.toml package.version)
          echo "Old package version: ${OLD_VERSION}"
          echo "New package veresion: ${{ env.RELEASE_VERSION }}"
      # - name: Update API version in package files
      #   uses: ciiiii/toml-editor@1.0.0
      #   with:
      #     file: api/Ballerina.toml
      #     key: "package.version"
      #     value: ${{ steps.vars.outputs.tag }}
      # - name: Update client version in package files
      #   uses: ciiiii/toml-editor@1.0.0
      #   with:
      #     file: client/Ballerina.toml
      #     key: "package.version"
      #     value: ${{ steps.vars.outputs.tag }}
      # - name: Commit version changes to repository
      #   uses: EndBug/add-and-commit@v9 # See: https://github.com/marketplace/actions/add-commit
      #   with:
      #     add: "."
      #     push: origin main
      #     default_author: github_actions
      #     message: "[GitHub Actions] Commit version updates"
  update-staging-db:
    name: Update Azure staging database
    needs: update-version
    runs-on: ubuntu-22.04
    environment: Staging
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Update Azure staging database
        run: |
          ls
          pwd
          cat ./db/schema/*.sql | mysql --host=$HOST --port=$PORT --user=$USER --password=$PASSWORD
        env:
          HOST: ${{ secrets.DB_HOST }}
          PORT: ${{ secrets.DB_PORT }}
          USER: ${{ secrets.DB_USER }}
          PASSWORD: ${{ secrets.DB_PASSWORD }}
          DATABASE: ${{ secrets.DB_DATABASE }}
  push-api-client:
    name: Publish GraphQL API Client
    needs: update-staging-db
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Build distribution archive of client package
        uses: ballerina-platform/ballerina-action@394eb82cc07e020948fee8d1474143ae393147f4
        with:
          args: pack
        env:
          WORKING_DIR: client
      - name: Push to central
        uses: ballerina-platform/ballerina-action@394eb82cc07e020948fee8d1474143ae393147f4
        with:
          args: push
        env:
          WORKING_DIR: client
